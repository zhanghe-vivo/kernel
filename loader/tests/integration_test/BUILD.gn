import("//build/templates/rust.gni")
import("//build/toolchain/bluekernel.gni")
import("//kernel/common_crate_rustflags.gni")

build_rust("loader_integration_test") {
  testonly = true
  crate_type = "bin"
  edition = "2021"
  sources = [ "src/test.rs" ]
  deps = [
    "//external/semihosting/v0.1.20:semihosting",
    "//kernel/kernel:bluekernel",
    "//kernel/loader:bluekernel_loader",
    "//kernel/loader/tests/inputs",
    "//kernel/rsrt:rsrt",
    "//libc:libc",
    "//librs:librs",
  ]
  if (coverage || profile) {
    deps += [
      "//kernel/kernel:atomic",
      "//kernel/loader:common_cov",
    ]
  }
  proc_macro_deps = [ "//kernel/test_harness:bluekernel_test_macro" ]
  inputs = [ "//kernel/kernel/src/boards/$board/link.x" ]
  rustflags = test_image_rustflags
}

gen_qemu_runner("loader_integration_test_runner") {
  testonly = true
  img = ":loader_integration_test"
  qemu = "$qemu_exe"
  machine = "$machine"
  semihosting = true
  if ("$board" == "qemu_virt64_aarch64") {
    qemu_args =
        "-cpu cortex-a53" + " -chardev stdio,id=con,mux=on" +
        " -serial chardev:con" + " -global virtio-mmio.force-legacy=false" +
        " -device virtio-rng-device,bus=virtio-mmio-bus.1" +
        " -mon chardev=con,mode=readline"
    block_img = "test.img"
  } else if ("$board" == "qemu_riscv64") {
    qemu_args = qemu_riscv64_run_args
  }
}

run_qemu_check("run_loader_integration_test") {
  testonly = true
  runner = ":loader_integration_test_runner"
  if (coverage) {
    img = ":loader_integration_test"
    checker = "//kernel/loader/tests/cov/lib.rs"
  } else {
    checker = "src/test.rs"
  }
}
